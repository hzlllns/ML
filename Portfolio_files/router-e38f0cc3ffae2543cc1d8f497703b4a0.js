(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,r=function(e,r){function o(){this.constructor=e}for(var i in r)t.call(r,i)&&(e[i]=r[i]);return o.prototype=r.prototype,e.prototype=new o,e.__super__=r.prototype,e};Paydirt.ExtensionRouter=function(t){function o(){return this._noClients=e(this._noClients,this),this._importProject=e(this._importProject,this),this._importJob=e(this._importJob,this),this._newBlock=e(this._newBlock,this),this.newRedboothProject=e(this.newRedboothProject,this),this.redboothBlocksNew=e(this.redboothBlocksNew,this),this.newBasecampProject=e(this.newBasecampProject,this),this.basecampBlocksNew=e(this.basecampBlocksNew,this),this.newTrelloBoard=e(this.newTrelloBoard,this),this.trelloBlocksNew=e(this.trelloBlocksNew,this),this.close=e(this.close,this),this.render=e(this.render,this),this.initialize=e(this.initialize,this),o.__super__.constructor.apply(this,arguments)}return r(o,t),o.prototype.routes={"extensions/timer":"tracker","extensions/tracker":"tracker","extensions/clients/:id/keywords":"clientsKeywords","extensions/time/log/:job_id":"blocksNew","extensions/trello/boards/import/:trello_board_id":"newTrelloBoard","extensions/trello/cards/:trello_card_id/log_time":"trelloBlocksNew","extensions/trello/cards/:trello_card_id/start_timer":"trelloTimerStart","extensions/basecamp/projects/import/:basecamp_project_id":"newBasecampProject","extensions/basecamp/projects/:basecamp_project_id/todos/:basecamp_todo_id/log_time":"basecampBlocksNew","extensions/basecamp/projects/:basecamp_project_id/todos/:basecamp_todo_id/start_timer":"basecampTimerStart","extensions/redbooth/projects/import/:redbooth_project_id":"newRedboothProject","extensions/redbooth/projects/:redbooth_project_id/tasks/:redbooth_task_id/log_time":"redboothBlocksNew","extensions/redbooth/projects/:redbooth_project_id/tasks/:redbooth_task_id/start_timer":"redboothTimerStart","*404":"render404"},o.prototype.initialize=function(){return $(document).on("click",".close_overlay",function(e){return function(t){return t.preventDefault(),e.close()}}(this)),$(document).on("click",'a[data-behaviour="extension_link"]',function(e){return function(t){return t.preventDefault(),e.navigate(t.currentTarget.pathname+t.currentTarget.search,{trigger:!0,replace:!0})}}(this)),$(document).on("click","a",function(e){return $(this).attr("href").match(/^http/)?(e.preventDefault(),e.stopImmediatePropagation(),top.postMessage({name:"paydirt:is:linkClicked",href:$(this).attr("href")},"*")):void 0}),window.addEventListener("message",function(e){return function(t){var r;switch(t.data.name){case"paydirt:do:navigate":return e.navigate(t.data.path,{trigger:!0,replace:!0});case"paydirt:do:toggleTracker":return null!=(r=Paydirt.trackerView)?r.toggle():void 0}}}(this))},o.prototype.render=function(){var e,t,r,o;return null!=(t=this._currentView)&&t.teardown(),this._currentView=this.view,$("#middle_content").html(null!=(r=this.view)?r.render().el:void 0),null!=Paydirt.Utilities.getParameterByName("autoHide")&&null!=(o=Paydirt.tracker)&&o.set({autohide:"true"===Paydirt.Utilities.getParameterByName("autoHide")}),window.scroll(0,0),e=!$("#middle_content").is(":empty"),$("body").toggleClass("overlay",e),this.dimensionsChanging()},o.prototype.dimensionsChanging=function(e){return null==e&&(e=!1),e&&top.postMessage({name:"paydirt:is:dimensions",dimensions:{width:"100%",height:"100%"}},"*"),clearTimeout(window.snapTimeout),$("body").hasClass("overlay")?top.postMessage({name:"paydirt:is:dimensions",dimensions:{width:"100%",height:"100%"}},"*"):window.snapTimeout=setTimeout(function(){var e,t,r,o,i;return e=$(document).outerHeight(),r=$("#tracker .flash-message .text:visible").outerWidth(),t=$("#tracker .flash-message .text").offset().top,$("#tracker").hasClass("showing")?(o="100%",i=""+($("#tracker").outerWidth()+r+10)+"px"):(i=""+(r+10)+"px",o=$("#tracker .flash-message .text").is(":visible")?""+(e-t+10)+"px":"0px"),top.postMessage({name:"paydirt:is:dimensions",dimensions:{width:i,height:o}},"*")},360)},o.prototype.close=function(){return $("#flash").empty(),this.view=null,this.render()},o.prototype.tracker=function(){var e,t,r;return this.view=null,+(e=Paydirt.Utilities.getParameterByName("client"))&&null!=(t=Paydirt.trackerView)&&t.suggest(e),null!=(r=Paydirt.trackerView)&&r.show(),this.render()},o.prototype.clientsKeywords=function(e){var t;return t=Paydirt.clients.get(e),this.view=new Paydirt.Views.WorkSignals.Index({model:t,collection:t.work_signals}),this.render()},o.prototype.blocksNew=function(e){return Paydirt.block=new Paydirt.Models.Block,this.view=new Paydirt.Views.Extensions.Blocks.New({model:Paydirt.block,jobId:e}),this.render()},o.prototype.trelloBlocksNew=function(e){return this._newBlock("Trello",null,e)},o.prototype.trelloTimerStart=function(e){return this._startTimer("Trello",null,e)},o.prototype.newTrelloBoard=function(e){return this._importProject("Trello",e)},o.prototype.basecampBlocksNew=function(e,t){return this._newBlock("Basecamp",e,t)},o.prototype.basecampTimerStart=function(e,t){return this._startTimer("Basecamp",e,t)},o.prototype.newBasecampProject=function(e){return this._importProject("Basecamp",e)},o.prototype.redboothBlocksNew=function(e,t){return this._newBlock("Redbooth",e,t)},o.prototype.redboothTimerStart=function(e,t){return this._startTimer("Redbooth",e,t)},o.prototype.newRedboothProject=function(e){return this._importProject("Redbooth",e)},o.prototype._newBlock=function(e,t,r){var o;switch(e){case"Trello":o=Paydirt.jobs.findWhere({trello_card_id:r});break;case"Basecamp":o=Paydirt.jobs.findWhere({basecamp_todo_id:+r});break;case"Redbooth":o=Paydirt.jobs.findWhere({redbooth_task_id:+r})}return o?(Paydirt.block=new Paydirt.Models.Block,this.view=new Paydirt.Views.Extensions.Blocks.New({model:Paydirt.block,jobId:o.id}),this.render()):this._importJob(e,t,r,function(o){return function(){return o._newBlock(e,t,r)}}(this))},o.prototype._startTimer=function(e,t,r){var o,i,n;switch(this.view=null,e){case"Trello":o=Paydirt.jobs.findWhere({trello_card_id:r});break;case"Basecamp":o=Paydirt.jobs.findWhere({basecamp_todo_id:+r});break;case"Redbooth":o=Paydirt.jobs.findWhere({redbooth_task_id:+r})}return o?(Paydirt.tracker.get("block")?null!=(i=Paydirt.trackerView)&&i.showFlash("<i class='icon-warning-sign'></i>&nbsp;&nbsp; There is already a timer running &ndash; you need to stop it first"):Paydirt.tracker.start({minutesAgo:0,jobId:o.id}),null!=(n=Paydirt.trackerView)&&n.show(),this.render()):this._importJob(e,t,r,function(o){return function(){return o._startTimer(e,t,r)}}(this))},o.prototype._importJob=function(e,t,r,o){var i,n,s,a;switch(e){case"Trello":a="/integrations/trello/create_job_from_card",n="card",i={trello_card_id:r};break;case"Basecamp":if(s=Paydirt.projects.findWhere({basecamp_project_id:+t}),a="/integrations/basecamp/create_job_from_todo",n="todo",i={basecamp_project_id:t,basecamp_todo_id:r},null==s)return void this._importProject(e,t,o);break;case"Redbooth":if(s=Paydirt.projects.findWhere({redbooth_project_id:+t}),a="/integrations/redbooth/create_job_from_task",n="task",i={redbooth_project_id:t,redbooth_task_id:r},null==s)return void this._importProject(e,t,o)}return $.ajax({type:"POST",url:a,data:i,success:function(e){return function(t){return t.redirect?e.navigate(t.redirect,{trigger:!0,replace:!0}):(Paydirt.jobs.updateFromPush(t.job),"function"==typeof o?o():void 0)}}(this),error:function(e){return function(t){return e.view=new Paydirt.Views.Notification({heading:"We couldn't import that "+n,message:t.responseText,confirm:"Okay",onConfirm:e.close}),e.render()}}(this)}),this.view=new Paydirt.Views.Notification({cssClass:"loading",message:"<i class='icon-refresh icon-spin'></i> Fetching "+n+" from "+e+"..."}),this.render()},o.prototype._importProject=function(e,t,r){var o,i,n,s;switch(r||(r=function(e){return function(){return e.view=new Paydirt.Views.Notification({heading:"You can now log time for the "+n+" on this "+i+"!",message:"Just click the 'Log Time' link when you're viewing "+n,confirm:"Got it",onConfirm:e.close}),e.render()}}(this)),e){case"Trello":i="Trello Board",n="card",s={importServiceName:e,importTarget:i,jobName:n,fetchURL:"/integrations/trello/fetch_open_boards",createURL:"/integrations/trello/create_project_from_board"};break;case"Basecamp":i="Basecamp Project",n="todo",o=Paydirt.Utilities.getParameterByName("basecamp_account_id"),s={basecamp_account_id:o,importServiceName:e,importTarget:i,jobName:n,fetchURL:"/integrations/basecamp/fetch_current_projects",createURL:"/integrations/basecamp/create_project_from_basecamp_project"};break;case"Redbooth":i="Redbooth Project",n="task",s={importServiceName:e,importTarget:i,jobName:n,fetchURL:"/integrations/redbooth/fetch_current_projects",createURL:"/integrations/redbooth/create_project_from_redbooth_project"}}return Paydirt.clients.length?(_.extend(s,{project_id:t,extension:!0,closeOnSuccess:!1,success:r}),this.view=new Paydirt.Views.Projects.Import(s),this.render()):this._noClients(i)},o.prototype._noClients=function(e){return this.view=new Paydirt.Views.Notification({heading:"You need a client first",message:"You need to create a client in Paydirt before we can import this "+e+". It only takes half a minute.",confirm:"Okay, lets go",onConfirm:function(e){return function(){return e.close(),top.postMessage({name:"paydirt:is:linkClicked",href:Paydirt.baseURL+"/clients/new"},"*")}}(this)}),this.render()},o}(Backbone.Router)}).call(this);